<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>text detection</title>
<!--    <link rel="stylesheet" href="bootstrap/css/bootstrap.min.css">-->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css"
          integrity="sha384-HSMxcRTRxnN+Bdg0JdbxYKrThecOKuH5zCYotlSAcp1+c8xmyTe9GYg1l9a69psu" crossorigin="anonymous">
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vue@2/dist/vue.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mammoth@1.4.8/mammoth.browser.min.js"></script>
</head>

<body>
<div class="container-fluid" >
    <div class="row" style="margin-top: 25px" id="fileUpload">

        <div class="col-md-7" style="background:#f5f5f5; height: 600px" >
            <input type="file" id="fileInput" @change="upload(false)" ref="componentLeft" style="margin-top: 10px">
            <div v-html="contents" style="margin-top: 10px; overflow: auto; height: 525px;background-color: white"
                 class="form-control col-md-12"></div>
        </div>

        <div class="col-md-5" style="background:#f5f5f5; height: 600px">
            <button class="btn-sm col-md-12" style="float:left;margin-top: 10px">规则校验</button>
            <table class="table table-hover table-striped col-md-12">
                <thead>
                    <tr>
                        <th>可能错误信息</th>
                        <th>others</th>
                    </tr>
                </thead>
                <tbody>
                    <tr v-for="(item,index) in errorInfo">
                        <td class="col-md-11">{{item.text}}</td>
                        <td class="col-md-1"><button class="btn-primary btn-sm btn">N</button></td>
                    </tr>
                </tbody>
            </table>
        </div>

    </div>
</div>

<script>
    let vm = new Vue({
        el: "#fileUpload",
        data:{
            errorInfo:[],
            contents:""
        },
        mounted:function (){

        },
        methods: {
            //模拟返回测试数据 由于没有配前端环境 就这么测试了
            testData:function (flag){
                if(flag){
                    let testResponseData={
                        "value": {
                            "detectionModels": [
                                {
                                    "text": "对年度实现规模以上工业总产值在全区排前五名的街道，分别奖励50万元、40万元、30万元、20万元、10万元",
                                    "input": "每年工业总产值在全区排前二十名的街道，分别奖励50万元、30万元、20万元",
                                    "segmentNum": 2,
                                    "sentenceNum": 1
                                },
                                {
                                    "text": "对年度实现规模以上工业总产值在全区排前五名的街道，分别奖励50万元、40万元、30万元、20万元、10万元",
                                    "input": "每年工业总产值在全区排前二十名的街道，分别奖励50万元、30万元、20万元",
                                    "segmentNum": 5,
                                    "sentenceNum": 1
                                }
                            ]
                        },
                        "errorMessage": null,
                        "status": 1,
                        "errorCode": null
                    };
                    this.errorInfo=testResponseData.value.detectionModels;
                }
            },

            //post file
            upload:function (isString) {
                if(isString){
                    this.uploadString(false);
                    return;
                }
                const that =this;
                const input = this.$refs.componentLeft
                let form = new FormData();
                let files=input.files || [];
                if (!files.length) return
                let file=files[0];

                form.append("file", file);

                axios.post("/text/detection/file/",form, {
                    headers: {'Content-Type': 'multipart/form-data'}
                    })
                    .then(function (response) {
                            that.errorInfo=response.data.value.detectionModels;
                            console.log(response);
                        that.contentsRead(file);
                    }, function (err) {
                            console.log(err);
                    });
            },

            //post string
            uploadString:function (post){
                const that=this;
                const input = this.$refs.componentLeft
                let files=input.files || [];
                if (!files.length) return
                let file=files[0];

                //str class.string
                const str= this.StringProcess();

                const data={text:str};
                if(post){
                    axios.post("/text/detection/text/",data,{
                        headers: {'Content-Type': 'application/json;charset=UTF-8'}
                        }).then(function (response) {
                            that.errorInfo=response.data.value.detectionModels;
                            console.log(response);
                        }, function (err) {
                            console.log(err);
                        });
                }else{
                    this.testData(true);
                }
                this.contentsRead(file);
            },

            //去掉html标签
            StringProcess:function(){
                let str=this.contents;
                return str.split(/<\/?.+?>/gi).join('');
            },

            //读取文件内容,转化为html格式,在网页中显示
            contentsRead:function (selectedFile){
                const that=this;
                let reader = new FileReader();
                reader.onloadend = function(event) {
                    let arrayBuffer = this.result;
                    mammoth.convertToHtml({arrayBuffer: arrayBuffer}).then(function (resultObject) {
                        that.contents=resultObject.value;
                        console.log(that.contents)
                        that.contentsProcess();
                    });
                };
                reader.readAsArrayBuffer(selectedFile);
            },

            //处理文件内容，标注出违背规则的地方
            contentsProcess:function (){
                // /<\/?.+?>/gi
                // /\<\/p\>/gi
                let strList=this.contents.split(/<\/?p>/gi).filter(item => item !=='' );
                console.log(this.errorInfo)
                for(let i=0; i<this.errorInfo.length; i++){
                    let segmentNum=this.errorInfo[i].segmentNum;
                    let sentenceNum=this.errorInfo[i].sentenceNum;

                    let processedSegment=strList[segmentNum-1].split("。");
                    processedSegment.splice(sentenceNum-1,0,"<strong style='color: #2e6da4'>");
                    processedSegment.splice(sentenceNum+1,0,"</strong>");
                    console.log(processedSegment);

                    strList.splice(segmentNum-1,1,processedSegment.join(""));
                    console.log(strList);
                }
                this.contents=strList[0]+"<p>"+strList.slice(1).join("<\p><p>")+"</p>";
            }
        }
    })

</script>


</body>
</html>